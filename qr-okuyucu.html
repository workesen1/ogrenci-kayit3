<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Kod Doğrulama</title>
<style>
body{margin:0;font-family:sans-serif;transition: background 0.5s;}
.container{padding:20px;max-width:600px;margin:auto;}
#reader{width:100%;border:3px solid #667eea;border-radius:10px;margin-bottom:20px;}
#dogrulama-sonuc{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:48px;font-weight:900;color:white;padding:30px 50px;border-radius:20px;display:none;z-index:9999;text-align:center;text-shadow:2px 2px 5px rgba(0,0,0,0.3);}
.basarili{display:block;}
.basarisiz{background:#ffc107;color:#856404;display:block;padding:20px;}
</style>
</head>
<body>
<div class="container">
<h1>📱 QR Kod Doğrulama</h1>
<div id="reader"></div>
<div id="dogrulama-sonuc"></div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
const GOOGLE_SCRIPT_URL='https://script.google.com/macros/s/AKfycby88sR995SjulMsD414XPi2LS7E6m-aJj6-2OGeizfMIIzPg7rlGOSj2Kf1HdNQpq4H/exec';
const sonucDiv=document.getElementById('dogrulama-sonuc');
let islemDevam=false, sonOkunanQR='', sonOkumaZamani=0;

function gosterMesaj(mesaj,tip){
  if(tip==='basarili'){
    document.body.style.backgroundColor='#28a745';
    sonucDiv.className='basarili';
    sonucDiv.innerHTML=mesaj;
    sonucDiv.style.display='block';
    const audio=new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
    audio.play();
    navigator.vibrate && navigator.vibrate([200,100,200]);
    setTimeout(()=>{
      sonucDiv.style.display='none';
      document.body.style.background='linear-gradient(135deg,#667eea 0%,#764ba2 100%)';
      islemDevam=false;
    },3000);
  } else {
    sonucDiv.className='basarisiz';
    sonucDiv.innerHTML=mesaj;
    sonucDiv.style.display='block';
    navigator.vibrate && navigator.vibrate([500]);
    setTimeout(()=>{sonucDiv.style.display='none';islemDevam=false;},3000);
  }
}

function qrKoduDogrula(qrData){
  if(islemDevam) return;
  islemDevam=true;
  fetch(GOOGLE_SCRIPT_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    mode:'cors',
    body:JSON.stringify({action:'dogrula',qrData})
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.verified) gosterMesaj('✅ Hoşgeldiniz!','basarili');
    else gosterMesaj('⚠️ '+data.message,'basarisiz');
  })
  .catch(err=>{
    console.error(err);
    gosterMesaj('⚠️ Bağlantı hatası','basarisiz');
  });
}

function onScanSuccess(decodedText){
  const simdikiZaman=Date.now();
  if(decodedText===sonOkunanQR && (simdikiZaman-sonOkumaZamani)<3000) return;
  sonOkunanQR=decodedText; sonOkumaZamani=simdikiZaman;
  qrKoduDogrula(decodedText);
}

new Html5QrcodeScanner("reader",{fps:10,qrbox:250,rememberLastUsedCamera:true,showTorchButtonIfSupported:true,formatsToSupport:[Html5QrcodeSupportedFormats.QR_CODE]},false)
.render(onScanSuccess,()=>{});
</script>
</body>
</html>
